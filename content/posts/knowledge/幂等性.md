---
title: "幂等性"
date: 2021-07-07T09:35:33+08:00
draft: false

tags: ['api']
categories: ["月霜天的小笔记"]
comment: true
toc: true
autoCollapseToc: false
---

## 一、什么是幂等？

幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于[抽象代数](https://baike.baidu.com/item/抽象代数/1537111)中。

在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些[函数](https://baike.baidu.com/item/函数/301912)不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的.更复杂的操作幂等保证是利用唯一交易号(流水号)实现。

幂等性：就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。

## 二、使用场景

### 1、前端重复提交

用户注册，用户创建商品等操作，前端都会提交一些数据给后台服务，后台需要根据用户提交的数据在数据库中创建记录。如果用户不小心多点了几次，后端收到了好几次提交，这时就会在数据库中重复创建了多条记录。这就是接口没有幂等性带来的 bug。

### 2、接口超时重试

对于给第三方调用的接口，有可能会因为网络原因而调用失败，这时，一般在设计的时候会对接口调用加上失败重试的机制。如果第一次调用已经执行了一半时，发生了网络异常。这时再次调用时就会因为脏数据的存在而出现调用异常。

### 3、消息重复消费

在使用消息中间件来处理消息队列，且手动 ack 确认消息被正常消费时。如果消费者突然断开连接，那么已经执行了一半的消息会重新放回队列。

当消息被其他消费者重新消费时，如果没有幂等性，就会导致消息重复消费时结果异常，如数据库重复数据，数据库数据冲突，资源重复等。

## 三、解决方案

### 1、token机制

通过token 机制实现接口的幂等性,这是一种比较通用性的实现方法。

![](https://cdn.jsdelivr.net/gh/betterfor/cloudImage/images/2021/07/07/2056765809.png)

流程：

1、客户端会先发送一个请求去获取 token，服务端会生成一个全局唯一的 ID 作为 token 保存在 redis 中，同时把这个 ID 返回给客户端

2、客户端第二次调用业务请求的时候必须携带这个 token

3、服务端会校验这个 token，如果校验成功，则执行业务，并删除 redis 中的 token

4、如果校验失败，说明 redis 中已经没有对应的 token，则表示重复操作，直接返回指定的结果给客户端

### 2、mysql锁

这种实现方式是利用 mysql 唯一索引的特性

![](https://cdn.jsdelivr.net/gh/betterfor/cloudImage/images/2021/07/07/3238177408.png)

流程：

1、建立一张去重表，其中某个字段需要建立唯一索引

2、客户端去请求服务端，服务端会将这次请求的一些信息插入这张去重表中

3、因为表中某个字段带有唯一索引，如果插入成功，证明表中没有这次请求的信息，则执行后续的业务逻辑

4、如果插入失败，则代表已经执行过当前请求，直接返回

### 3、redis锁

这种实现方式是基于 SETNX 命令实现的

![](https://cdn.jsdelivr.net/gh/betterfor/cloudImage/images/2021/07/07/910987620.png)

流程：

1、客户端先请求服务端，会拿到一个能代表这次请求业务的唯一字段

2、将该字段以 SETNX 的方式存入 redis 中，并根据业务设置相应的超时时间

3、如果设置成功，证明这是第一次请求，则执行后续的业务逻辑

4、如果设置失败，则代表已经执行过当前请求，直接返回

## 总结

这几种实现幂等的方式其实都是大同小异的，类似的还有使用状态机、悲观锁、乐观锁的方式来实现，都是比较简单的。

类似于分布锁：

- 数据库锁，一个表中包含方法名等字段，并在方法名字段上创建唯一索引
- redis锁，setnx为锁添加一个超时时间
- zookeeper锁：创建目录，在目录下创建临时顺序节点，获取最小顺序节点号